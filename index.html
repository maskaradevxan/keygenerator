<script>
const ADMIN_USER = 'celes';
const ADMIN_PASS = 'clean';

const storeKey = 'cln_keys_v1';
let keys = JSON.parse(localStorage.getItem(storeKey) || '[]');
const $ = id => document.getElementById(id);

function login() {
  if ($('u').value === ADMIN_USER && $('p').value === ADMIN_PASS) {
    $('login').classList.add('hidden');
    $('panel').classList.remove('hidden');
    render();
  } else $('lmsg').textContent = 'Credenciais inválidas';
}

function rnd() {
  const a = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  return Array.from({ length: 5 }, () =>
    a[Math.floor(Math.random() * a.length)]
  ).join('');
}

function generate() {
  const p = $('prefix').value.toUpperCase();
  const s = $('exp');
  const d = parseInt(s.value);
  const tag = s.options[s.selectedIndex].dataset.tag;
  const exp = d === 0 ? null : Date.now() + d * 86400000;

  const key = `${p}-${tag}-${rnd()}-${rnd()}-${rnd()}`;
  keys.unshift({ key, tag, exp });
  localStorage.setItem(storeKey, JSON.stringify(keys));
  render();
}

async function validate() {
  const k = $('check').value.trim();
  const f = keys.find(x => x.key === k);

  if (!f) {
    $('vmsg').innerHTML = '<span class="warn">Key não encontrada</span>';
    return;
  }
  if (f.exp && Date.now() > f.exp) {
    $('vmsg').innerHTML = '<span class="warn">Key expirada</span>';
    return;
  }

  $('vmsg').innerHTML = `<span class="ok">Key válida (${f.tag})</span>`;

  try {
    // parâmetros
    const repo = "maskaradevxan/keygenerator";
    const workflowFile = "add-key.yml"; // nome do workflow
    const branch = "main"; // ou o branch que você usa
    const githubToken = "SEU_TOKEN_AQUI"; // precisa de um token válido

    const response = await fetch(
      `https://api.github.com/repos/${repo}/actions/workflows/${workflowFile}/dispatches`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/vnd.github.v3+json",
          "Authorization": "Bearer " + githubToken
        },
        body: JSON.stringify({
          ref: branch,
          inputs: { key: k }
        })
      }
    );

    if (response.ok) {
      alert("Key enviada ao GitHub Actions!");
    } else {
      const err = await response.json();
      alert("Erro ao chamar workflow: " + JSON.stringify(err));
    }
  } catch (err) {
    alert("Erro na requisição: " + err.message);
  }
}
</script>
